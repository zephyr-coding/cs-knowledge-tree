## CPU 上下文切换

即使是单核处理器也支持多线程执行代码，CPU 通过给每个线程分配 CPU 时间片来实现这个机制。时间片是 CPU 分配给各个线程的时间，因为时间片非常短，所以 CPU 通过不停地切换线程执行，让我们感觉多个线程是同时执行的，时间片一般是几十毫秒 (ms)。

CPU 通过时间片分配算法来循环执行任务，当前任务执行一个时间片后会切换到下一个任务。但是，在切换前会保存上一个任务的状态，以便下次切换回这个任务时，可以再加载这个任务的状态。所以任务从保存到再加载的过程就是一次上下文切换。

## volatile

## synchronized

### 锁升级

![[Java 对象头的长度.png]]

![[Mark Word.png]]

#### 锁升级流程

![[Pasted image 20231014004534.png]]

#### 无锁

#### 偏向锁

![[Pasted image 20231014002801.png]]

#### 轻量级锁

加锁 cas

![[Pasted image 20231014002959.png]]

可重入

![[Pasted image 20231014003011.png]]

加锁流程

![[Pasted image 20231014003025.png]]

解锁流程

![[Pasted image 20231014003741.png]]

轻量级解锁时，会使用原子的 CAS 操作将 Displaced Mark Word 替换回到对象头，如果成功，则表示没有竞争发生。如果失败，表示当前锁存在竞争，锁就会膨胀成重量级锁。

#### 重量级锁
